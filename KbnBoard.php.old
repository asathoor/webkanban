<?php
/**
* File: KbnBoard.php
* Purpose: view the webkanban, CRUD notes
*/

include('config.php');

if(!isset($wpdb)){
	echo "the WPDB class not found";
}

?>

<div class="wrap">
<h1>Kanban Board</H1>

<?php
/**
* Icons
*/
echo "<div>";

$icon = $fil = plugin_dir_url(__FILE__) . 'PNG/14.png'; // sti til ikonfil
echo "<a href='admin.php?page=Webkanban_New_Note'>
	<img src='$icon' alt='New Task' /><br />
	Add New Task
	</a>";

echo "</div>";

/**
* View Columns
*/
function KbnGetHeaders(){
	include('config.php');

	if(!isset($wpdb)){
		echo "WPDB MISSING"; // fik fejlmedd. om query on non-object, fordi wpdb manglede
	}

	$KbnBoardHeaders = $wpdb->get_results("SELECT * FROM `KbnStates` ORDER BY `Order`") or trigger_error(mysql_error()); 


	// Headers and div begin
	foreach($KbnBoardHeaders as $row){


	
		echo "<div style='
			position:relative; 
			float: left;
			width: 180px;
			margin:5px;
			text-align: center;
			background-color:"
			. $row->Color
			. "'><h3>" 
		. $row->State 
		. "</h3>
		";

	// get the notes
	$getNotesSQL = "SELECT * FROM `kbnNotes` WHERE `KbnStatesId` = $row->Id ORDER BY `DeadLine` ASC";
	
	$KbnGetNote = $wpdb->get_results($getNotesSQL) or trigger_error(mysql_error()); 

	foreach($KbnGetNote as $row){
		echo "<div 
			style='position:relative;
			float:center;
			text-align: left;
			padding: 5px 5px 5px 5px;
			margin: 0px 5px 5px 5px;
			border-top: 1px solid #000
			';>
			<p><strong>";
			
			// link or just the title
			if($row->URL > ''){
				echo "<a href='$row->URL'> $row->Title </a>";
			}
			else{
				echo $row->Title;
			}

			// if image echo it
			if($row->Image > ''){
				echo "<img src='$row->Image' alt='$row->Title' class='KbnImage' width='100%' height='*' />";
			}

		echo "</strong><br />
			Who: $row->Who <br />
			Start: $row->StartDate<br />
			Deadline $row->DeadLine<br />
			</p> 
			<!-- der skal linkes korrekt til plugin-folder -->
			<form method='post' enctype='multipart/form-data' action='";
		// echo	plugin_dir_url(__FILE__) . "KbnNotes-edit.php"; // action in external file

		echo	"'>
			<input type='hidden' name='EditKbnNote' value='$row->Id' />
			<button name='Submit' value='KbnNoteUpdated'>Edit</button>
			<button name='DeleteKanbanNote' value='$row->Id'>Delete</button>
			</form>
			</div>";

	}
// $fil = plugin_dir_url(__FILE__) . 'minFil.php';
	// end of div
		echo "</div>";
		}
}
?>
<?
/**
* NEW
*/
if(isset($_POST['NewKanbanNote'])){
	unset($_POST['EditKbnNote']);
}


/**
* DELETE A NOTE
*/

if(isset($_POST['DeleteKanbanNote'])) {
	$sql = "DELETE FROM `kbnNotes` WHERE `Id` =" . $_POST['DeleteKanbanNote'] . ";";
	$wpdb->query($sql);
	unset($_POST['EditKbnNote']);
	echo "Note deleted.";
}


/**
* EDIT Form Inkluderes
*/

if(isset($_POST['EditKbnNote'])) {
	include('KbnNotes-edit.php'); 
}

/*
* EDIT UPDATE SQL
*/

if (isset($_POST['NewNote'])) { 

	$wpdb->update(
			'kbnNotes',
			array(
				'Id' => $_POST['Id'],
				'KbnProjectsId' => $_POST['KbnProjectsId'],
				'KbnStatesId' => $_POST['KbnStatesId'],
				'Title' => $_POST['Title'],
				'What' => $_POST['What'],
				'Who' => $_POST['Who'],
				'StartDate' => $_POST['StartDate'],
				'DeadLine' => $_POST['DeadLine'],
				'Created' => $_POST['Created'],
				'URL' => $_POST['URL'],
				'Image' => $_POST['Image'],
			),
			array(
				'ID' => $_POST['Id']
			),
			array(
			'%d',
			'%d',
			'%d',
			'%s',
			'%s',
			'%s',
			'%s',
			'%s',
			'%s',
			'%s',
			'%s'
			),
			array(
			'%d'
			)
		
		);

		// add to the log
		$wpdb->insert(
			"KbnLog",
			array(
				'Id' => NULL,
				'What' => $_POST['What'],
				'KbnNotesId' => $_POST['Id'],
				'KbnStatesId' => $_POST['KbnStatesId'],
				'KbnProjectsId' => $_POST['KbnProjectsId'],
				'KbnNotesName' => $_POST['Title'],
				'Date' => date('Y-m-d G:i:s')
			),
			array(
				'%d', '%s', '%d', '%d', '%d', '%s', '%s'
			)
		);
}
else{
	// echo "Submit button in KbnNotes-edit.php doesn't work";
}




KbnGetHeaders(); // display kanbans
?>
</div>
