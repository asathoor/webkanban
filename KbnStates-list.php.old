<? 
include('config.php');

/**
* Class creating buttons etc.
*/

class KbnProjects {

	// The edit form
	public function edit($action, $value) {
		return "<form action='"
		. $action
		."' method='post' enctype='multipart/form-data'>
			<button name='EditKbnProject' value='"
			. $value
			. "' type='submit'>Edit</button>
		</form>
		";
	}

	// The delete button
	public function delete($action, $deleteMe) {
		return "
		<form action='"
		. $action
		. "' method='post' enctype='multipart/form-data'>
			<button name='DeleteKanbanProject' value='"
			. $deleteMe
			."' type='submit'>Delete</button>
		</form>	";
		echo $deleteMe;
				

	}

	// The create a new entry button
	public function newKbn() {
		return "
		<form action='' method='post' enctype='multipart/form-data'>
			<button name='NewKbnProjectSubmit' value='value' type='submit'>New States</button>
		</form>
		";
	}

/*
	public function selectStates(){
		// $table, $col
		// select column
		// $sql = "SELECT 'Id', 'State' FROM States"; // query
		echo "test";
		$MyResult = $this.$wpdb->get_results("SELECT * FROM `KbnStates`") or trigger_error(mysql_error()); 
		// prepare sikkerhed

		//echo $sql;
		//print_r($result);

		// loop through array
		foreach($MyResult as $row) {
			// selectbox
			echo "
			<input type='text' name='SelectId' value='" 
			. $row->Id
			. "' />
			<select>
				<option value='SelectText'>"
			. $row->State
			. "</option>
			</select>
			";
		}



	}
*/

}

$KbnStatesCRUD = new KbnProjects(); // klassen instantieres via config.php

/**
* Edit Form Inkluderes
*/

if(isset($_POST['EditKbnProject'])) {
	include('KbnStates-edit.php'); 
}
else{
	echo "KbnStates-edit.php not found or POST error. POST value =" . $_POST['EditKbnProject'];
}

/**
* New Entry in the log
*/

if(isset($_POST['NewKbnProjectSubmit'])) {
      include('KbnStates-new.php'); // redigerer felterne
}

/**
* New Entry Entered in DB
*/

if (isset($_POST['State'])) { 

	print_r($_POST);

	// a la codex
	$wpdb->insert(
		'KbnStates',
		array(
			'Id' => NULL,
			'KbnProjectsId' => $_POST['KbnProjectsId'],
			'Color' => $_POST['Color'],
			'Limit' => $_POST['Limit'],
			'State' => $_POST['State']
		),
		array(
			'%d',
			'%d',
			'%s',
			'%d',
			'%s'
		)

	);

} 

/**
* Delete
*/

if(isset($_POST['DeleteKanbanProject'])) {
      echo $_POST['Kanban Project']; // Har vaerdien 'value' ;-)
      $sql = "DELETE FROM `KbnStates` WHERE `id` ='" . $_POST['DeleteKanbanProject'] . "';";
      $wpdb->query($sql);
}

/**
* Detect if new Log post is created
*/

if (isset($_POST['KbnProjectSubmitted'])) { 
	foreach($_POST AS $key => $value) { $_POST[$key] = mysql_real_escape_string($value); } 
	$sql = "INSERT INTO `KbnProjects` ( `Id` ,  `Name`) VALUES(  '{$_POST['Id']}' ,  '{$_POST['Name']}'); "; 
	$wpdb->query($wpdb->prepare($sql)); // Query
	echo "Added row.<br />"; 
	}

/*
* Edit UPDATE SQL
*/

// if (isset($_POST['UpdateField'])) { 
// if ($_SESSION['KillBill'] == 1) { 
if (KbnStatesEdited == 'OK') { 

	// echo "Ok vi er gennem if sÃ¦tningen og sessionen er lig ..." . $_SESSION['KillBill'];
	echo "Opdaterer no.: " . $_POST['UpdateField'];

	$wpdb->update(
			'KbnStates',
			array(
				'Id' => NULL,
				'KbnProjectsId' => $_POST['KbnProjectsId'],
				'Color' => $_POST['Color'],
				'Limit' => $_POST['Limit'],
				'State' => $_POST['State']
			),
			array(
				'Id' => $_POST['UpdateField']
			),
			array(
			'%d',
			'%d',
			'%s',
			'%d',
			'%s'
			),
			array(
			'%d'
			)
		
		);
		// $_SESSION['KillBill'] = 0; // do now show form any more

}
else {
	// echo "KillBill ain't not set so doin' nothin'";
}

/**
* Table 
*/
screen_icon();
echo "<div class='wrap'>";
echo "
	<h2>Kanban States Editor</h2>
	<p>
	  Here you can define the states of your kanban. You can give the columns names such as 'To Do', 'Doing' or similar. 
	</p>
	<ul>
	  <li><strong>Kbn Project Id</strong>: is the name of the kanban board. (## next version: show name not id)</li>
	  <li><strong>Color</strong>: the color of the note. You can use hex values here, e.g. #DEFF9A.</li>
	  <li><strong>Limit</strong>: in the kanban philosophy we limit the number of tasks, that you kan do in a working day or session. It is the limit of the work in progress. 0 = unlimited.</li>
	  <li><strong>State</strong>: is the name of the process, such as 'Backlog', 'To Do', 'Done' etc.</li>
	</ul>
";
echo "<table class='widefat fixed' cellspacing='0'>"; 
echo "<caption>  Kanban States  </caption>";
echo "<tr>"; 
//echo "<th class='manage-column column-columnname'><b>Id</b></th>"; 
//echo "<th class='manage-column column-columnname'><b>Name</b></th>"; 
//echo "<th class='manage-column column-columnname'><b>Edit / Delete</b></th>";

echo "
<thead><tr>
<th class='draggable'>Id
</th><th class='manage-column column-columnname'>Kbn Project Id
</th><th class='manage-column column-columnname'>Color
</th><th class='manage-column column-columnname'>Limit
</th><th class='manage-column column-columnname'>State
<th class='manage-column column-columnname'><b>Edit / Delete</b></th>
</th></tr>
</thead>
";


echo "</tr>"; 

$result = $wpdb->get_results("SELECT * FROM `KbnStates`") or trigger_error(mysql_error()); 

foreach($result as $row){
	echo "<tr>";  
	echo "<td class='manage-column column-columnname'>" . $row->Id . "</td>";  
	echo "<td class='manage-column column-columnname'>" . $row->KbnProjectsId . "</td>";
	echo "<td class='manage-column column-columnname'>" . $row->Color . "</td>";  
	echo "<td class='manage-column column-columnname'>" . $row->Limit . "</td>";  
	echo "<td class='manage-column column-columnname'>" . $row->State . "</td>";  
  
	echo "<td class='manage-column column-columnname'>" 
	. $KbnStatesCRUD->edit('', $row->Id)
	. $KbnStatesCRUD->delete('', $row->Id) 
	. $KbnStatesCRUD->newKbn()
	.  "</td> "; // formatterer knapperne og giver dem en value
	echo "</tr>"; 
}

echo "</table>";
echo "</div>";
?>
